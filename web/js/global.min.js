/*
 * MIT License
 *
 * Copyright (c) 2018 Krzysztof "RouNdeL" Zdulski
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
/**
 * Created by Krzysiek on 11/08/2017.
 */
"use strict";$(function(){const e=$("#global-form");const n=$("#btn-save");const t={tooltip:"always",tooltip_position:"bottom"};const a=[$("#brightness-pc").slider(t),$("#brightness-gpu").slider(t),$("#brightness-fan-1").slider(t),$("#brightness-fan-2").slider(t),$("#brightness-fan-3").slider(t),$("#brightness-strip").slider(t)];const i=$(".brightness-slider-fan");let s=false;function l(t){let a=objectifyForm(e.serializeArray());a.enabled=$("input[name=enabled]")[0].checked;a.csgo_enabled=$("input[name=csgo_enabled]")[0].checked;a.fan_count=parseInt(a.fan_count);a.profile_index=parseInt(a.current_profile);delete a.current_profile;if(t===true){a.brightness=[parseInt($("#brightness-pc").val()),parseInt($("#brightness-gpu").val()),parseInt($("#brightness-fan-1").val()),parseInt($("#brightness-fan-2").val()),parseInt($("#brightness-fan-3").val()),parseInt($("#brightness-strip").val())];a.order=r()}else{delete a.brightness}a.auto_increment=parseFloat(a.auto_increment);let l=JSON.stringify(a);i.addClass("hidden-xs-up");for(let e=0;e<a.fan_count;e++){i.eq(e).removeClass("hidden-xs-up")}$.ajax("/api/save/global",{method:"POST",data:l,contentType:"application/json"}).done(function(e){if(e.message!==null)showSnackbar(e.message,2500);if(t===true){n.prop("disabled",true);$("#auto-increment").val(e.auto_increment_val);s=false}}).fail(function(e){showSnackbar(e.responseJSON.message);console.error(e)})}n.click(e=>l(true));let o=e.find("select[name='fan_count'],select[name='current_profile'],"+"input[name='enabled'],input[name='csgo_enabled']");e.find("input,select").not(o).not("#auto-increment").change(()=>{s=true;n.prop("disabled",false)});o.change(()=>{l(false)});$(window).on("beforeunload",function(e){if(!s)return undefined;const n="It looks like you have been editing something. "+"If you leave before saving, your changes will be lost.";(e||window.event).returnValue=n;//Gecko + IE
return n;//Gecko + Webkit, Safari, Chrome etc.
});$("#globals-profiles-active").sortable({connectWith:"#globals-profiles-inactive",receive:function(e,n){if($(this).children().length>8){showSnackbar("You can only have 8 active profiles!");$(n.sender).sortable("cancel")}c()},remove:function(e,n){if($(this).children().length<1){showSnackbar("You need at least 1 active profile!");$(this).sortable("cancel")}c()},change:function(e,t){s=true;n.prop("disabled",false)}});$("#globals-profiles-inactive").sortable({connectWith:"#globals-profiles-active"});$("#auto-increment").change(function(e){let n=$(this).val().replace(/,/g,".").replace(/s/,"");if(n.match(/(min|m)/)){let e=parseFloat(n);n=isNaN(e)?0:e*60}else if(n.match(/(hour|h)/)){let e=parseFloat(n);n=isNaN(e)?0:e*60*60}$(this).val(getIncrementTiming(convertIncrementToTiming(n))+"s");l(false)});if(typeof EventSource!=="undefined"){const e=new EventSource("/api/events");e.addEventListener("globals",({data:e})=>{try{if(!s){const n=JSON.parse(e).data;$("a.nav-link.highlight").removeClass("highlight");$("a.nav-link").eq(parseInt(n.highlight_index)).addClass("highlight");$("li.list-group-item.highlight").removeClass("highlight");$("li.list-group-item[data-index="+n.highlight_profile_index+"]").addClass("highlight");$("select[name=current_profile]").val(n.highlight_profile_index);$("input[name=enabled]")[0].checked=n.leds_enabled;$("input[name=csgo_enabled]")[0].checked=n.csgo_enabled;for(let e=0;e<n.brightness.length;e++){if(a[e]!==undefined&&a[e]!==null&&typeof a[e].slider==="function"){a[e].slider("setValue",n.brightness[e])}}$("select[name=fan_count]").val(n.fan_count);i.addClass("hidden-xs-up");for(let e=0;e<n.fan_count;e++){i.eq(e).removeClass("hidden-xs-up")}let t=$("input[name=auto_increment]");if(!t.is(":focus")){t.val(n.auto_increment+"s")}}}catch(n){console.error(n,e)}});
// noinspection EqualityComparisonWithCoercionJS
e.addEventListener("tcp_status",({data:e})=>$("#global-warning-tcp").toggleClass("hidden-xs-up",e==="1"))}function r(){const e={active:[],inactive:[]};const n=$("#globals-profiles-active").find("li");const t=$("#globals-profiles-inactive").find("li");for(let t=0;t<n.length;t++){e.active.push(n.eq(t).data("index"))}for(let n=0;n<t.length;n++){e.inactive.push(t.eq(n).data("index"))}return e}function c(){const e=$("#globals-profiles-active").find("li");let n=$("select[name=current_profile]");n.empty();for(let t=0;t<e.length;t++){n.append($("<option>",{value:e.eq(t).data("index"),text:e.eq(t).text()}))}}});function showSnackbar(e,n=2500){const t=$("#snackbar");t.text(e);t.addClass("show");setTimeout(()=>t.removeClass("show"),n)}function objectifyForm(e){const n={};for(let t=0;t<e.length;t++){n[e[t]["name"]]=e[t]["value"]}return n}