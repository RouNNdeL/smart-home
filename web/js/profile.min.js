/*
 * MIT License
 *
 * Copyright (c) 2018 Krzysztof "RouNdeL" Zdulski
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */

"use strict";const REGEX_DEVICE=/(pc|gpu|strip|fan-(\d))/;const COLOR_TEMPLATE='<div class="color-container row mb-1">\n            <div class="col-auto ml-3">\n                <button class="btn btn-danger color-delete-btn" type="button" role="button" title="$title_delete"><span class="oi oi-trash"></span></button>\n            </div>\n            <div class="col-auto ml-1">\n                <button class="btn color-jump-btn" type="button" role="button" title="$title_jump"><span class="oi oi-action-redo"></span></button>\n            </div>\n            <div class="col pl-1">\n                <div class="input-group colorpicker-component">\n                    <input type="text" class="form-control color-input" value="$color" autocomplete="off" \n                    aria-autocomplete="none" spellcheck="false"/>\n                    <span class="input-group-addon color-swatch-handle"><i></i></span>\n                </div>\n            </div>\n        </div>';const FPS=64;let profile_n;let profile_index;let changes=false;let previous_hash=window.location.hash;let string_title_delete;let string_title_jump;$.ajax("/api/get_string.php?name=profile_btn_hint_delete").done(e=>string_title_delete=e.string);$.ajax("/api/get_string.php?name=profile_btn_hint_jump").done(e=>string_title_jump=e.string);$(function(){handleHash();$('[data-toggle="tooltip"]').tooltip();const e=[];const t=$("#main-navbar").find("li.nav-item a.nav-link.active");const i=$("#profile-name");const n=$("#profile-name,select[name=strip_mode],input[name=strip_front_pc]");profile_n=parseInt($("#profile_n").val());profile_index=parseInt($("#current_profile").val());const o=$("#btn-delete-profile").not(".disabled");const s=$("#profile-warning-led-disabled");const a=$("#profile-warning-diff-profile");const r=$("#profile-warning-profile-inactive");let l;let c;refreshColorPickers();registerFormListeners();$.ajax("/api/get_string.php?name=profile_delete_confirm").done(e=>l=e.string);$.ajax("/api/get_string.php?name=profile_apply_force_confirm").done(e=>c=e.string);$(window).on("hashchange",function(){handleHash()});$(".swatches-container").sortable({handle:".color-swatch-handle"});i.on("input",function(){let e=$(this).val();if(e.length>30){e=e.substring(0,30);$(this).val(e)}if(e.length===0)t.text($(this).attr("placeholder"));else t.text(e)});n.change(saveProfileParams);o.click(function(){if(confirm(l)){$.ajax("/api/remove/profile",{method:"POST",data:JSON.stringify({profile_n:profile_n})}).done(e=>window.location.href="/")}});if(typeof EventSource!=="undefined"){const e=new EventSource("/api/events");e.addEventListener("globals",({data:e})=>{try{const t=JSON.parse(e).data;$("a.nav-link.highlight").removeClass("highlight");if(profile_n!==t.highlight_profile_index){$("a.nav-link").eq(parseInt(t.highlight_index)).addClass("highlight")}if(t.active_indexes.indexOf(profile_n)>=0){r.addClass("hidden-xs-up");a.toggleClass("hidden-xs-up",profile_n===t.highlight_profile_index);a.find("a.current_profile_url").attr("href","/profile/"+t.highlight_profile_index)}else{a.addClass("hidden-xs-up");r.removeClass("hidden-xs-up");r.find("a.current_profile_url").attr("href","/profile/"+t.highlight_profile_index)}s.toggleClass("hidden-xs-up",t.leds_enabled);profile_index=t.highlight_profile_index}catch(t){console.error(t,e)}});e.addEventListener("tcp_status",({data:e})=>$("#profile-warning-tcp").toggleClass("hidden-xs-up",e==="1"))}$(".device-settings-container").each(function(t){e.push(new DeviceSetting($(this)))});$(window).keydown(function(e){if(e.keyCode===13&&!i.is(":focus")){e.preventDefault();return false}});$("#device-settings-submit").click(e=>f(false));$("#device-settings-submit-force").click(e=>{if(confirm(c)){f(true)}});function f(t){const i={profile_n:profile_n,force:t,devices:[]};for(let t=0;t<e.length;t++){i["devices"][t]=e[t].formToJson()}$.ajax("/api/save/profile",{method:"POST",data:JSON.stringify(i),contentType:"application/json"}).done(function(e){changes=false;if(e.message!==null)showSnackbar(e.message)}).fail(function(e){console.error(e)})}});$(window).on("beforeunload",function(e){$.ajax("/api/explicit_save",{method:"POST",async:false})});function showSnackbar(e,t=2500){const i=$("#snackbar");i.text(e);i.addClass("show");setTimeout(()=>i.removeClass("show"),t)}function handleHash(){let e;if(window.location.hash==="#enable_leds"){replaceHash(previous_hash);$.ajax("/api/enable_leds",{method:"POST"})}else if(window.location.hash==="#change_profile"){replaceHash(previous_hash);$.ajax("/api/change_profile",{method:"POST",data:profile_n.toString()})}else if((e=window.location.hash.match(REGEX_DEVICE))!==null){$(".device-settings-container").addClass("hidden-xs-up");$("#device-"+e[1]).removeClass("hidden-xs-up");$(".device-header").addClass("hidden-xs-up");$("#header-"+e[1]).removeClass("hidden-xs-up");$(".device-link").removeClass("active");$("#device-link-"+e[1]).addClass("active")}previous_hash=window.location.hash}function replaceHash(e){history.replaceState("",document.title,window.location.pathname+window.location.search+e)}class DeviceSetting{constructor(e){this.parent=e;let t=this.limit_colors=16;this.id=e.attr("id");this.device_match=this.id.match(REGEX_DEVICE);if(this.device_match===null)throw new Error("Invalid parent id:",this.id);if(this.device_match[1]==="pc")this.device={type:"a",num:0};else if(this.device_match[1]==="gpu")this.device={type:"a",num:1};else if(this.device_match[1]==="strip")this.device={type:"d",num:3};else this.device={type:"d",num:parseInt(this.device_match[2])-1};this.limit_colors=parseInt(e.find(".swatches-container").data("color-limit"));const i=this;e.find(".add-color-btn").click(function(){const n=e.find(".color-container");const o=n.length;if(o<t){e.find(".color-delete-btn").prop("disabled",false);const i=getColorSwatch(o);e.find(".swatches-container").append($(i));refreshColorPickers();if(o===t-1)$(this).addClass("hidden-xs-up")}i.refreshListeners()});e.find("#effect-select-"+this.device_match[1]).change(i=>{changes=true;const n=JSON.stringify({type:this.device.type,effect:parseInt($(i.target).val())});$.ajax("/api/get_html/timing_args",{method:"POST",data:n,contentType:"application/json"}).done(i=>{if(i.status!=="success"){console.error("Error getting args, timings: ",i)}else{const n=e.find(".main-container");const o=e.find(".timing-container, .args-container, input[type=hidden]");o.remove();n.append($.parseHTML(i.html));this.limit_colors=t=i.limit_colors;this.refreshColorsLimit();registerFormListeners()}}).fail(e=>{console.error(e)})});this.refreshColorsLimit();this.refreshListeners()}refreshColorsLimit(){let e=this.parent.find(".color-container");if(this.limit_colors>0&&e.length===0){const e=getColorSwatch(0);this.parent.find(".swatches-container").append($(e));this.parent.find(".color-delete-btn").prop("disabled",true)}e=this.parent.find(".color-container");if(e.length<this.limit_colors){this.parent.find(".add-color-btn").removeClass("hidden-xs-up")}else{this.parent.find(".add-color-btn").addClass("hidden-xs-up");this.limit_colors===0?e.remove():this.parent.find(".color-container:gt("+(this.limit_colors-1)+")").remove();const t=this.parent.find(".color-delete-btn");if(t.length===1)t.prop("disabled",true)}this.parent.find(".header-colors").toggleClass("hidden-xs-up",this.limit_colors===0);this.refreshListeners();refreshColorPickers()}refreshListeners(){const e=this;const t=this.parent.find(".color-delete-btn");t.off("click");t.click(function(i){const n=e.parent.find(".color-container").length;if(n>1)$(this).parent().parent().remove();if(n<=2){t.prop("disabled",true)}});const i=this.parent.find(".color-jump-btn");i.off("click");i.click(function(t){const i=e.parent.find(".color-container").length;const n=e.formToJson();let o=1;if(n.args.pieces_color_count!==undefined&&n.args.pieces_color_count>0){o=n.args.pieces_color_count}else if(n.args.rotating_color_count!==undefined&&n.args.rotating_color_count>0){o=n.args.rotating_color_count}else if(n.args.fill_fade_color_count!==undefined&&n.args.fill_fade_color_count>0){o=n.args.fill_fade_color_count}else if(n.args.spectrum_color_count!==undefined&&n.args.spectrum_color_count>0){o=n.args.spectrum_color_count}let s=1;if(n.args.color_cycles!==undefined&&n.args.color_cycles!==0){s=n.args.color_cycles}const a=Math.floor($(this).parent().parent().index()/o);const r=(n.times[0]+n.times[1]+n.times[2]+n.times[3])*s;const l=r*i;$.ajax("/api/jump_frame",{method:"POST",data:JSON.stringify({profile_n:profile_n,frame:(r*a+n.times[0]-n.times[5]+l)%l*FPS})})})}formToJson(){const e=this.parent.find("#device-form-"+this.device_match[1]).serializeArray();const t={};t.times=[];t.args={};t.colors=[];t.device=this.device;for(let i=0;i<e.length;i++){let n=e[i].name.match(/time_(.*)/);let o=e[i].name.match(/arg_(.*)/);if(n!==null){switch(n[1]){case"off":t.times[0]=parseFloat(e[i].value);break;case"fadein":t.times[1]=parseFloat(e[i].value);break;case"on":t.times[2]=parseFloat(e[i].value);break;case"fadeout":t.times[3]=parseFloat(e[i].value);break;case"rotation":t.times[4]=parseFloat(e[i].value);break;case"offset":t.times[5]=parseFloat(e[i].value);break}}else if(o!==null){t.args[o[1]]=parseInt(e[i].value)}else if(e[i].name!=="color"){t[e[i].name]=e[i].value}}t.colors=this.getColors();t.effect=parseInt(t.effect);return t}getColors(){const e=[];const t=this.parent.find(".color-input");for(let i=0;i<t.length;i++){e.push(t.eq(i).val().substring(1))}return e}}let hexDigits=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function rgb2hex(e,t=true){e=e.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);return(t?"#":"")+hex(e[1])+hex(e[2])+hex(e[3])}function hex(e){return isNaN(e)?"00":hexDigits[(e-e%16)/16]+hexDigits[e%16]}function getColorSwatch(e){return $.parseHTML(COLOR_TEMPLATE.replace("$label","color-"+e).replace("$color","#ff0000").replace("$title_delete",string_title_delete).replace("$title_jump",string_title_jump))}function refreshColorPickers(){$(".colorpicker-component").colorpicker({useAlpha:false,extensions:[{name:"swatches",colors:{white:"#ffffff",red:"#ff0000",green:"#00ff00",blue:"#0000ff",magenta:"#ff00ff",yellow:"#ffff00",cyan:"#00ffff"},namesAsValues:false}]});$(window).on("beforeunload",function(e){if(!changes)return undefined;const t="It looks like you have been editing something. "+"If you leave before saving, your changes will be lost.";(e||window.event).returnValue=t;return t})}function registerFormListeners(){const e=$(".timing-container").find("input");const t=$(".args-container").find("input[type=text]");const i=$("input,select").not(e).not(t).not("select.effect-select, #profile-name,select[name=strip_mode],input[name=strip_front_pc]");e.off("change");t.off("change");i.off("change");i.change(function(e){changes=true});t.change(function(e){changes=true;let t=$(this).val();try{t=math.eval(t);$(this).val(t)}catch(e){$(this).val(0)}});e.change(function(e){changes=true;let t=$(this).val().replace(/,/g,".");if(t.match(/(min|m)/)){let e=parseFloat(t);t=isNaN(e)?0:e*60}else{try{t=math.eval(t)}catch(e){t=0}}$(this).val(getTiming(convertToTiming(t)))})}function saveProfileParams(){const e=$("input[name=strip_front_pc]")[0].checked;const t=$("select[name=strip_mode]");if(e&&parseInt(t.val())===2){t.val(0)}t.find(".strip-mode-select-opt-disableable").prop("disabled",e);$.ajax("/api/save/profile/params",{method:"POST",data:JSON.stringify({profile_n:profile_n,name:$("#profile-name").val(),flags:(e?1<<2:0)|t.val()})}).fail(function(e){console.error(e)})}